#!/usr/bin/python3
# coding: utf-8
from debssolib.certs import Certs
from debssolib.cli import Command, Cli
import sys
import tempfile
import subprocess

#    res = requests.get("https://nm.debian.org/api/whoami", cert=(cert_file, key_file))

class Curl(Command):
    """
    Run curl adding extra options to use Debian SSO client certificates
    """
    def argument_parser(self):
        parser = super().argument_parser()
        parser.usage = parser.prog + " [curl options...]"
        return parser

    def run(self):
        parser = self.argument_parser()
        args, unparsed = parser.parse_known_args()
        certs = Certs()
        cert, key = certs.extract_from_browser()
        with tempfile.TemporaryDirectory() as tmpdir:
            crt_pathname = os.path.join(tmpdir, "sso.crt")
            with open(crt_pathname, "wb") as fd:
                os.chmod(fd.fileno(), 0o400)
                fd.write(cert)

            key_pathname = os.path.join(tmpdir, "sso.key")
            with open(key_pathname, "wb") as fd:
                os.chmod(fd.fileno(), 0o400)
                fd.write(key)

            cmd = ["curl", "--key", key_pathname, "--cert", crt_pathname]
            cmd.extend(unparsed)
            proc = subprocess.Popen(cmd)
            res = proc.wait()
        sys.exit(res)


def main():
    cli = Cli()
    cli.commands.append(Curl())
    cli.run()


if __name__ == "__main__":
    main()
